## Progress Log

### 2026-01-22: US-DOC-001 - Documents Schema
- Added `documents` table to `convex/schema.ts`
- Fields: organizationId, title, content (markdown), createdAt, updatedAt, createdBy
- Indexes: by_organization, by_organization_updated
- Note: Pre-existing TS errors in codebase unrelated to this change. Convex codegen passes.

### 2026-01-22: US-DOC-002 - Documents CRUD Functions
- Created `convex/documents/functions.ts` with 5 functions:
  - `createDocument` - mutation, creates doc with title/content
  - `getDocument` - query, fetches single doc, validates org ownership
  - `listMyDocuments` - query, returns all org docs sorted by updatedAt desc
  - `updateDocument` - mutation, updates title/content, sets updatedAt
  - `deleteDocument` - mutation, removes doc, validates org ownership
- All functions verify auth and organizationId
- Uses `by_organization_updated` index for sorted listing
- Patterns match `convex/canvas/functions.ts`
- Convex codegen passes. Logic review passed.

### 2026-01-22: US-DOC-003 - Documents List Page
- Created `src/routes/documents/index.tsx`:
  - Route `/documents` with `beforeLoad` auth guard
  - Lists org documents with title, last updated date
  - "New Document" button creates and navigates to editor
  - Delete button with confirmation dialog
  - Empty state with icon and CTA button
  - Loading state with skeleton cards
- Modified `src/components/app-sidebar.tsx`:
  - Added "Documents" link with FileText icon
- Browser testing passed: all acceptance criteria verified
- Note: Pre-existing TS errors in codebase unrelated to this change

### 2026-01-22: US-DOC-004 - Document Editor Page
- Created `src/routes/documents/$documentId.tsx`:
  - Route `/documents/$documentId` with `beforeLoad` auth guard
  - Editable title field - auto-saves on blur
  - Large textarea for content - debounced auto-save (1s delay)
  - "Saved" / "Saving..." indicator in header
  - Back button navigates to /documents list
  - Loading state with spinner
  - 404 handling when document doesn't exist (Convex validates ID format)
- Fixed race conditions from logic review:
  - Uses refs (lastSavedContentRef, lastSavedTitleRef) to compare against last saved value
  - Tracks pendingSavesRef to avoid premature "saved" status
  - Toast notifications on save errors
- Browser testing passed: title editing, content auto-save, "Saved" indicator all working
- Next: US-LR-001 (readLink AI tool)

### 2026-01-22: US-LR-001 - readLink AI Tool
- Created `readLinkTool` in `convex/canvas/chat.ts`
- Tool reads content from URLs without creating database records (read-only operation)
- Supports 5 platforms:
  - YouTube: Extracts video transcript via Scrape Creators API
  - Twitter/X: Extracts tweet text and author via Scrape Creators API
  - TikTok: Extracts video title, author, transcript (with WEBVTT parsing)
  - Facebook Ads: Extracts ad title, body, link description, page name, transcript
  - Website: Scrapes markdown content via Firecrawl API
- URL detection via `detectPlatform()` helper function
- Returns structured data: `{ success, platform, content, error }`
- Registered in agent tools object alongside generateImage
- Browser testing verified: AI successfully reads YouTube link and summarizes content
- Pre-existing TS errors in codebase unrelated to this change
- Next: US-LR-002 (Unsupported URL handling) or US-LR-003 (Tool display in chat UI)

### 2026-01-23: US-LR-003 - Display readLink Tool Results in Chat UI
- Integrated ReadLinkTool component into `src/features/chat/components/Chat.tsx`
- Added tool part filtering using type guard `isToolPart()` that checks for `type.startsWith("tool-")`
- ReadLinkTool component in `src/components/ai-elements/read-link-tool.tsx` was already created, just needed type fixes
- Displays:
  - Loading state: Clock icon with "Reading link..." header
  - Success state: Green checkmark, platform badge (YouTube/Twitter/Website), title, truncated preview, "View original" link
  - Error state: Red styling with error message
- Fixed type errors:
  - Added `getAuthor()` helper to properly type author extraction
  - Changed conditional rendering to use explicit null checks
  - Fixed unused variable warnings with void pattern
- Browser testing verified: YouTube and website URLs both display tool cards correctly
- Logic review passed - tool part type format `"tool-{toolName}"` confirmed matching SDK (verified via deltas.test.ts)
- Next: US-LR-002 (Unsupported URL handling) or US-CHAT-002 (Chat hub query)

### 2026-01-23: US-LR-002 - Handle Unsupported URLs Gracefully
- Added `SUPPORTED_PLATFORMS_MSG` constant to avoid message duplication
- Updated 3 error messages in `convex/canvas/chat.ts`:
  1. Invalid URL format error now includes supported platforms
  2. Website extraction failure now explains potential causes (auth, JS rendering, blocking)
  3. Catch block error now formats with platform and supported platforms list
- Browser testing verified: AI responds helpfully when given invalid URL, listing supported platforms
- Logic review passed, applied suggestion to extract duplicated string to constant
- Convex typecheck passes (pre-existing frontend errors unrelated)
- Next: US-CHAT-002 (Chat hub query) or US-CHAT-001 (Chat hub page)

### 2026-01-23: US-CHAT-002 - Chat Hub Query
- Created `listCanvasesWithChats` query in `convex/canvas/functions.ts`
- Query returns canvases that have at least one chat node
- Returns: canvasId, canvasName, chatNodeCount, lastMessageTimestamp
- Sorted by lastMessageTimestamp descending
- Uses efficient batching with Promise.all:
  - Gets chat canvas_nodes by organization (filters nodeType="chat")
  - Batch fetches canvases
  - Batch queries threads via by_canvas index for each canvas
- Logic review caught issue: initial impl only used selectedThreadId for timestamps
  - Fixed to query ALL threads per canvas via by_canvas index
- Convex codegen passes (pre-existing frontend errors unrelated)
- Next: US-CHAT-001 (Chat hub page) or US-NAV-001 (Dashboard chat links)

### 2026-01-23: US-CHAT-001 - Chat Hub Page (SUPERSEDED BY US-NAV-001)
- Created `/chats` route at `src/routes/chats/index.tsx`
- Added "Chats" link to sidebar between Documents and Pricing (with MessageSquare icon)
- Page displays canvases that have chat nodes:
  - Canvas name, chat count ("1 chat" / "2 chats"), relative time ("32m ago")
  - Sorted by lastMessageTimestamp descending (most recent first)
  - Clicking card navigates to `/canvas/{canvasId}/chat`
- Uses `listCanvasesWithChats` query from US-CHAT-002
- Empty state with MessageSquare icon + "No chats yet" message
- Loading state with skeleton cards
- Pattern follows documents/index.tsx for consistency
- Meets FR-NAV-2 (fast loading) - uses timestamp not message preview
- Browser testing verified: navigation, card click, URL routing all work
- Pre-existing TS errors in codebase unrelated to this change
- **NOTE: This feature was superseded by US-NAV-001 which adds chat button directly to dashboard canvas cards**

### 2026-01-23: US-NAV-001 - Add Chat Link to Canvas Cards
- Added chat button (MessageSquare icon) to canvas cards on dashboard
- Modified `convex/canvas/functions.ts`:
  - Updated `listCanvases` query to include `hasChatNodes` boolean
  - Queries canvas_nodes with nodeType="chat" filter and builds Set of canvas IDs with chats
  - Removed now-unused `listCanvasesWithChats` query (dead code after /chats removal)
- Modified `src/routes/index.tsx`:
  - Added MessageSquare import from lucide-react
  - Added chat button to canvas card hover actions (green styling)
  - Button only shows if `canvas.hasChatNodes` is true
  - Button has title="Open Chat" for tooltip
  - Navigates to `/canvas/{canvasId}/chat` on click
- Removed `/chats` route:
  - Deleted `src/routes/chats/index.tsx`
  - Removed "Chats" link from sidebar in `src/components/app-sidebar.tsx`
- Logic review passed - caught dead code (listCanvasesWithChats) which was removed
- Browser testing verified with agent-browser:
  - Chat button appears on hover with green styling
  - Clicking navigates to /canvas/{id}/chat
  - Chat page loads correctly with "Back to Canvas" and thread sidebar
- Browser testing verified with agent-browser
- Note: PRD was marked complete but user added new story (US-NAV-002)

### 2026-01-23: US-NAV-002 - Canvas Switcher Dropdown in Chat Header
- Added dropdown to chat page header allowing quick switching between canvases
- Modified `convex/canvas/functions.ts`:
  - Added `listCanvasesWithChats` query (reintroduced, was removed in US-NAV-001)
  - Query fetches chat nodes, groups by canvasId, batch fetches canvases
  - Includes org ownership verification per logic review
- Modified `src/routes/canvas/$canvasId/chat.tsx`:
  - Added DropdownMenu imports (shadcn component)
  - Added useNavigate hook for programmatic navigation
  - Added canvasesWithChats query
  - Replaced static title with dropdown trigger button (canvas title + ChevronDown)
  - Dropdown shows loading spinner, empty state ("No other canvases with chats"), or canvas list
  - Current canvas highlighted with Check icon
- Logic review caught: missing org ownership check in query - fixed
- Logic review caught: empty state message confusing - changed to "No other canvases with chats"
- Browser testing found issue: switching canvases didn't auto-select a thread
  - Root cause: `selectedThreadId` state persisted from previous canvas
  - Fix: Added useEffect to reset `selectedThreadId` to null when `canvasId` changes
  - This triggers existing auto-select effect to pick first thread from new canvas
- Browser testing verified: dropdown opens, canvas switching works, thread auto-selects
- PRD COMPLETE - All stories including new US-NAV-002 are done
- Next developer: All features implemented. PRD miscellaneous improvements is complete.
