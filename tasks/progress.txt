## Progress Log

### 2026-01-22: US-DOC-001 - Documents Schema
- Added `documents` table to `convex/schema.ts`
- Fields: organizationId, title, content (markdown), createdAt, updatedAt, createdBy
- Indexes: by_organization, by_organization_updated
- Note: Pre-existing TS errors in codebase unrelated to this change. Convex codegen passes.

### 2026-01-22: US-DOC-002 - Documents CRUD Functions
- Created `convex/documents/functions.ts` with 5 functions:
  - `createDocument` - mutation, creates doc with title/content
  - `getDocument` - query, fetches single doc, validates org ownership
  - `listMyDocuments` - query, returns all org docs sorted by updatedAt desc
  - `updateDocument` - mutation, updates title/content, sets updatedAt
  - `deleteDocument` - mutation, removes doc, validates org ownership
- All functions verify auth and organizationId
- Uses `by_organization_updated` index for sorted listing
- Patterns match `convex/canvas/functions.ts`
- Convex codegen passes. Logic review passed.

### 2026-01-22: US-DOC-003 - Documents List Page
- Created `src/routes/documents/index.tsx`:
  - Route `/documents` with `beforeLoad` auth guard
  - Lists org documents with title, last updated date
  - "New Document" button creates and navigates to editor
  - Delete button with confirmation dialog
  - Empty state with icon and CTA button
  - Loading state with skeleton cards
- Modified `src/components/app-sidebar.tsx`:
  - Added "Documents" link with FileText icon
- Browser testing passed: all acceptance criteria verified
- Note: Pre-existing TS errors in codebase unrelated to this change

### 2026-01-22: US-DOC-004 - Document Editor Page
- Created `src/routes/documents/$documentId.tsx`:
  - Route `/documents/$documentId` with `beforeLoad` auth guard
  - Editable title field - auto-saves on blur
  - Large textarea for content - debounced auto-save (1s delay)
  - "Saved" / "Saving..." indicator in header
  - Back button navigates to /documents list
  - Loading state with spinner
  - 404 handling when document doesn't exist (Convex validates ID format)
- Fixed race conditions from logic review:
  - Uses refs (lastSavedContentRef, lastSavedTitleRef) to compare against last saved value
  - Tracks pendingSavesRef to avoid premature "saved" status
  - Toast notifications on save errors
- Browser testing passed: title editing, content auto-save, "Saved" indicator all working
- Next: US-LR-001 (readLink AI tool)

### 2026-01-22: US-LR-001 - readLink AI Tool
- Created `readLinkTool` in `convex/canvas/chat.ts`
- Tool reads content from URLs without creating database records (read-only operation)
- Supports 5 platforms:
  - YouTube: Extracts video transcript via Scrape Creators API
  - Twitter/X: Extracts tweet text and author via Scrape Creators API
  - TikTok: Extracts video title, author, transcript (with WEBVTT parsing)
  - Facebook Ads: Extracts ad title, body, link description, page name, transcript
  - Website: Scrapes markdown content via Firecrawl API
- URL detection via `detectPlatform()` helper function
- Returns structured data: `{ success, platform, content, error }`
- Registered in agent tools object alongside generateImage
- Browser testing verified: AI successfully reads YouTube link and summarizes content
- Pre-existing TS errors in codebase unrelated to this change
- Next: US-LR-002 (Unsupported URL handling) or US-LR-003 (Tool display in chat UI)

### 2026-01-23: US-LR-003 - Display readLink Tool Results in Chat UI
- Integrated ReadLinkTool component into `src/features/chat/components/Chat.tsx`
- Added tool part filtering using type guard `isToolPart()` that checks for `type.startsWith("tool-")`
- ReadLinkTool component in `src/components/ai-elements/read-link-tool.tsx` was already created, just needed type fixes
- Displays:
  - Loading state: Clock icon with "Reading link..." header
  - Success state: Green checkmark, platform badge (YouTube/Twitter/Website), title, truncated preview, "View original" link
  - Error state: Red styling with error message
- Fixed type errors:
  - Added `getAuthor()` helper to properly type author extraction
  - Changed conditional rendering to use explicit null checks
  - Fixed unused variable warnings with void pattern
- Browser testing verified: YouTube and website URLs both display tool cards correctly
- Logic review passed - tool part type format `"tool-{toolName}"` confirmed matching SDK (verified via deltas.test.ts)
- Next: US-LR-002 (Unsupported URL handling) or US-CHAT-002 (Chat hub query)

### 2026-01-23: US-LR-002 - Handle Unsupported URLs Gracefully
- Added `SUPPORTED_PLATFORMS_MSG` constant to avoid message duplication
- Updated 3 error messages in `convex/canvas/chat.ts`:
  1. Invalid URL format error now includes supported platforms
  2. Website extraction failure now explains potential causes (auth, JS rendering, blocking)
  3. Catch block error now formats with platform and supported platforms list
- Browser testing verified: AI responds helpfully when given invalid URL, listing supported platforms
- Logic review passed, applied suggestion to extract duplicated string to constant
- Convex typecheck passes (pre-existing frontend errors unrelated)
- Next: US-CHAT-002 (Chat hub query) or US-CHAT-001 (Chat hub page)

### 2026-01-23: US-CHAT-002 - Chat Hub Query
- Created `listCanvasesWithChats` query in `convex/canvas/functions.ts`
- Query returns canvases that have at least one chat node
- Returns: canvasId, canvasName, chatNodeCount, lastMessageTimestamp
- Sorted by lastMessageTimestamp descending
- Uses efficient batching with Promise.all:
  - Gets chat canvas_nodes by organization (filters nodeType="chat")
  - Batch fetches canvases
  - Batch queries threads via by_canvas index for each canvas
- Logic review caught issue: initial impl only used selectedThreadId for timestamps
  - Fixed to query ALL threads per canvas via by_canvas index
- Convex codegen passes (pre-existing frontend errors unrelated)
- Next: US-CHAT-001 (Chat hub page) or US-NAV-001 (Dashboard chat links)

### 2026-01-23: US-CHAT-001 - Chat Hub Page (SUPERSEDED BY US-NAV-001)
- Created `/chats` route at `src/routes/chats/index.tsx`
- Added "Chats" link to sidebar between Documents and Pricing (with MessageSquare icon)
- Page displays canvases that have chat nodes:
  - Canvas name, chat count ("1 chat" / "2 chats"), relative time ("32m ago")
  - Sorted by lastMessageTimestamp descending (most recent first)
  - Clicking card navigates to `/canvas/{canvasId}/chat`
- Uses `listCanvasesWithChats` query from US-CHAT-002
- Empty state with MessageSquare icon + "No chats yet" message
- Loading state with skeleton cards
- Pattern follows documents/index.tsx for consistency
- Meets FR-NAV-2 (fast loading) - uses timestamp not message preview
- Browser testing verified: navigation, card click, URL routing all work
- Pre-existing TS errors in codebase unrelated to this change
- **NOTE: This feature was superseded by US-NAV-001 which adds chat button directly to dashboard canvas cards**

### 2026-01-23: US-NAV-001 - Add Chat Link to Canvas Cards
- Added chat button (MessageSquare icon) to canvas cards on dashboard
- Modified `convex/canvas/functions.ts`:
  - Updated `listCanvases` query to include `hasChatNodes` boolean
  - Queries canvas_nodes with nodeType="chat" filter and builds Set of canvas IDs with chats
  - Removed now-unused `listCanvasesWithChats` query (dead code after /chats removal)
- Modified `src/routes/index.tsx`:
  - Added MessageSquare import from lucide-react
  - Added chat button to canvas card hover actions (green styling)
  - Button only shows if `canvas.hasChatNodes` is true
  - Button has title="Open Chat" for tooltip
  - Navigates to `/canvas/{canvasId}/chat` on click
- Removed `/chats` route:
  - Deleted `src/routes/chats/index.tsx`
  - Removed "Chats" link from sidebar in `src/components/app-sidebar.tsx`
- Logic review passed - caught dead code (listCanvasesWithChats) which was removed
- Browser testing verified with agent-browser:
  - Chat button appears on hover with green styling
  - Clicking navigates to /canvas/{id}/chat
  - Chat page loads correctly with "Back to Canvas" and thread sidebar
- Browser testing verified with agent-browser
- Note: PRD was marked complete but user added new story (US-NAV-002)

### 2026-01-23: US-NAV-002 - Canvas Switcher Dropdown in Chat Header
- Added dropdown to chat page header allowing quick switching between canvases
- Modified `convex/canvas/functions.ts`:
  - Added `listCanvasesWithChats` query (reintroduced, was removed in US-NAV-001)
  - Query fetches chat nodes, groups by canvasId, batch fetches canvases
  - Includes org ownership verification per logic review
- Modified `src/routes/canvas/$canvasId/chat.tsx`:
  - Added DropdownMenu imports (shadcn component)
  - Added useNavigate hook for programmatic navigation
  - Added canvasesWithChats query
  - Replaced static title with dropdown trigger button (canvas title + ChevronDown)
  - Dropdown shows loading spinner, empty state ("No other canvases with chats"), or canvas list
  - Current canvas highlighted with Check icon
- Logic review caught: missing org ownership check in query - fixed
- Logic review caught: empty state message confusing - changed to "No other canvases with chats"
- Browser testing found issue: switching canvases didn't auto-select a thread
  - Root cause: `selectedThreadId` state persisted from previous canvas
  - Fix: Added useEffect to reset `selectedThreadId` to null when `canvasId` changes
  - This triggers existing auto-select effect to pick first thread from new canvas
- Browser testing verified: dropdown opens, canvas switching works, thread auto-selects
- PRD COMPLETE - All stories including new US-NAV-002 are done

### 2026-01-23: US-LR-004 - Enhanced Loading Indicator and Full Content Modal
- Improved ReadLinkTool component with better UX for loading states and content viewing
- Loading state changes:
  - Replaced ClockIcon with Loader2Icon (animate-spin) for clearer visual feedback
  - Added progress bar animation with pulse effect
  - Added "Fetching content..." text
  - Card now has primary border/background tint (border-primary/30 bg-primary/5) during loading
- Full content modal:
  - Added Dialog component with DialogTrigger button "View full content"
  - Button only appears when transcript > 200 characters
  - Modal shows platform icon, title, author (if available), scrollable full text
  - "View original source" link at bottom of modal
- Code cleanup from logic review:
  - Added DialogDescription with sr-only class for accessibility compliance
  - Hoisted computed values (author, preview, title, fullText) to avoid redundant function calls
  - Made hasMoreContent check explicit: `fullText !== null && fullText.length > 200`
- Browser testing verified: loading state, completed state, modal all working correctly
- Next developer: PRD miscellaneous improvements is COMPLETE. All features implemented.

### 2026-01-23: Remotion Hype Video Planning
- Created comprehensive video plan for 25-30 second hype video in `remotion-assets/VIDEO_PLAN.md`
- Captured 10 screenshots of key app screens for video assets:
  - 01-dashboard.png - Canvas list view
  - 02-chat-fullscreen.png - AI chat interface
  - 03-canvas-with-chat.png - Infinite canvas with chat node
  - 04-documents.png - Documents feature
  - 05-custom-agents.png - Custom agents page
  - 06-canvas-toolbar.png - Canvas with toolbar visible
  - 07-link-tool-loading.png - Link reading tool loading state
  - 08-link-tool-complete.png - Link reading tool completed state
  - 09-link-tool-modal.png - Full content modal
  - 10-canvas-switcher-dropdown.png - Canvas switcher dropdown
- Documented brand guidelines extracted from app.css:
  - Colors: Terracotta primary, warm cream background, chocolate sidebar
  - Typography: Lexend (display), DM Sans (body), JetBrains Mono (code)
  - Rounded 16px corners, organic feel with subtle textures
- Scene-by-scene breakdown (7 scenes):
  1. Logo Intro (0-3s) - Animated "Splat AI" logo
  2. Problem Statement (3-6s) - Pain point text
  3. Canvas Overview (6-11s) - Infinite canvas demo
  4. AI Chat Feature (11-16s) - Chat interaction
  5. Link Reading Tool (16-21s) - URL extraction feature
  6. Feature Montage (21-25s) - Quick cuts of features
  7. Call to Action (25-30s) - CTA and branding
- All assets placed in `/remotion-assets/screenshots/`
- Next developer: Set up Remotion project and implement video using VIDEO_PLAN.md

### 2026-02-01: US-FWS-001 - Exa Search Integration
- Created `convex/chat/tools.ts` with `fetchExaSearch` helper function
- Function searches the web via Exa API and returns full article content
- Installed `exa-js` package (v2.2.0)
- Uses named import: `import { Exa } from "exa-js";` (not default export)
- Added input validation: empty query throws error, numResults clamped to 1-100
- Error handling:
  - 401/unauthorized → "Invalid Exa API key"
  - 429/rate limit → "Exa rate limit exceeded - please try again later"
  - Other errors → "Exa search failed: {message}"
- Added `EXA_API_KEY` to `.env.example` with documentation
- Convex codegen passes
- Logic review approved with minor suggestions (applied input validation fix)
- Next story: US-FWS-002 (Implement Haiku Filtering Step)

### 2026-02-01: US-FWS-002 - Haiku Filtering Step
- Added `filterSearchResults` function to `convex/chat/tools.ts`
- Uses AI Gateway with Claude Haiku (`anthropic/claude-3-5-haiku-20241022`) for evaluation
- Evaluates each result against 3 criteria: promotional/SEO, spam/aggregated lists, paywalled
- Parallel execution via `Promise.all` for performance
- Fail-open design: if Haiku call fails, result is accepted by default
- Returns `{ accepted: ExaSearchResult[], rejected: (ExaSearchResult & { rejectionReason })[] }`
- JSON parsing handles markdown code block wrapping (common LLM output pattern)
- Type validation ensures response has correct shape before returning
- Added imports: `generateText` from "ai", `gateway` from "@ai-sdk/gateway"
- Convex codegen passes (pre-existing TS errors in frontend unrelated)
- Logic review approved - all acceptance criteria met
- Next story: US-FWS-003 (Create filteredWebSearch Tool)

### 2026-02-01: US-FWS-003 - Create filteredWebSearch Tool
- Created `filteredWebSearchTool` in `convex/canvas/chat.ts` using `createTool` pattern
- Tool defined with Zod schema: `{ query: string }`
- Tool orchestrates: search via Exa → filter via Haiku → return structured output
- Output schema: `{ success, accepted[], rejected[], searchTime, filterTime, error? }`
- Imports `fetchExaSearch` and `filterSearchResults` from `convex/chat/tools.ts`
- Two-phase execution with timing measurement for both search and filter phases
- Transforms results to include summaries (300 chars accepted, 200 chars rejected)
- Error handling returns structured error response (success: false) instead of throwing
- Registered tool in agent's tools object alongside `generateImage`, `readLink`
- Convex codegen passes (pre-existing frontend TS errors unrelated)
- Logic review approved - all acceptance criteria met
- Browser testing verified: tool is registered and accessible from chat sendMessage flow
- Note: AI doesn't always use the tool automatically - agent instructions may need to be updated to mention when to use filteredWebSearch (separate story)
- Next story: US-TK-001 (Implement TikTok Search API Integration)

### 2026-02-01: US-TK-001 - TikTok Search API Integration
- Created `fetchTikTokSearch` function in `convex/chat/tools.ts`
- Searches TikTok via Scrape Creators API: `GET /v1/tiktok/search/keyword`
- Parameters: query, `sort_by: most-liked`, `trim: true`
- Added types: `TikTokSearchResponse`, `TikTokSearchItem`, `TranscriptResponse`, `TikTokVideoResult`
- Created `parseWebVTT` helper to convert WebVTT transcripts to plain text
  - Handles WEBVTT header, timestamps, cue identifiers
  - Handles STYLE/REGION blocks (CSS styling)
  - Handles NOTE blocks (comments)
  - Strips WebVTT styling tags (`<v Speaker>`, `<b>`, `<i>`, etc.)
- Created private `fetchTikTokTranscript` helper with silent fallback
- Transcripts fetched in parallel via `Promise.all`
- API error handling: 401 (invalid key), 429 (rate limit), other HTTP errors
- Silent fallback to `"[No speech detected]"` if transcript fails or videoUrl empty
- `SCRAPE_CREATORS_API_KEY` already documented in `.env.example`
- Convex codegen passes
- Logic review found HIGH severity: parseWebVTT didn't handle STYLE/REGION/NOTE blocks or styling tags - FIXED
- Logic review found LOW severity: empty videoUrl wasted API call - FIXED
- Next story: US-TK-002 (Create searchTikTok Tool)

### 2026-02-01: US-TK-002 - Create searchTikTok Tool
- Created `searchTikTokTool` in `convex/canvas/chat.ts` using `createTool`
- Tool defined with Zod schema: `{ query: string }`
- Description explains it searches TikTok for videos with transcripts for creator insights
- Output schema matches PRD: `{ success, videos[], totalFound?, message?, error? }`
- Imports `fetchTikTokSearch` from `../chat/tools` (created in US-TK-001)
- Error handling returns structured error response instead of throwing
- Registered tool in agent's tools object alongside generateImage, readLink, filteredWebSearch
- Convex codegen passes
- Logic review passed - all acceptance criteria met
- Next story: US-UI-001 (Create TikTok Results Card Component)

### 2026-02-01: US-UI-001 & US-UI-002 - TikTok Results Card and Grid Components
- Created `src/components/ai-elements/tiktok-results.tsx` with two components:
  1. `TikTokResultsCard` - Individual video card with:
     - Thumbnail (9:16 aspect, capped height), ImageOffIcon fallback for missing images
     - @creatorHandle text
     - View/like/share stats with icons (EyeIcon, HeartIcon, Share2Icon)
     - Collapsible: shows thumbnail+stats collapsed, transcript+link expanded
     - "Open on TikTok" button opens video URL in new tab
     - formatNumber() helper for 1.2M, 45K, etc.
  2. `TikTokSearchTool` - Tool wrapper with:
     - Loading state: Loader2Icon spinner + "Searching TikTok..." + progress bar
     - Error state: AlertCircleIcon + error message
     - Success state: collapsible header "X videos found" + horizontal scrollable grid
     - Collapsed by default after initial render (per PRD US-UI-002)
- Logic review fixes applied:
  - Changed `isCollapsed` default to `true` per PRD spec
  - Added fallback key for video mapping: `key={video.tiktokId || video.videoUrl || index}`
  - Added `aria-label` on CollapsibleTrigger for accessibility
- TypeScript compiles with no errors in new component
- Pre-existing TS errors in codebase unrelated to this change
- Next story: US-UI-003 (Create Web Search Results Card Component)
- Note: Browser testing deferred to US-UI-005 when components are integrated into Chat.tsx

### 2026-02-01: US-UI-003 - Web Search Results Card Component
- Created `src/components/ai-elements/web-search-results.tsx` with:
  - `WebSearchCard` component - individual article card with:
    - Featured image (aspect-video) hidden when missing or on error
    - Favicon with GlobeIcon fallback
    - Title (linked, line-clamp-2), summary (line-clamp-2), author, date
    - Clicking card opens article URL in new tab
  - `decodeHtmlEntities()` helper using DOMParser for comprehensive entity support
    - SSR guard with basic regex fallback when document unavailable
  - `formatRelativeDate()` helper - Today, 1d ago, Nd ago, Nw ago, or "Mon YYYY"
    - Handles future dates gracefully
- Logic review fixes applied:
  - Changed HTML entity decoding to use browser's built-in textarea.innerHTML decoder
  - Added future date handling (returns formatted month/year instead of negative days)
  - Added aria-label for accessibility
- TypeScript compiles with no errors in new component
- Pre-existing TS errors in codebase unrelated to this change
- Note: Browser testing deferred to US-UI-005 when components are integrated into Chat.tsx

### 2026-02-01: US-UI-004 - Web Search Results Grid with Rejected Section
- Extended `src/components/ai-elements/web-search-results.tsx` with WebSearchTool wrapper
- Component structure:
  - `WebSearchTool` wrapper handles tool state + renders results grid
  - Loading state: "Searching & filtering web..." with spinner + progress bar
  - Error state: AlertCircleIcon + error message
  - Success state: collapsible accepted grid + collapsible rejected section
- Accepted results grid:
  - Responsive: 1 col mobile, 2 col tablet (`sm:grid-cols-2`), 3 col desktop (`lg:grid-cols-3`)
  - Uses existing `WebSearchCard` component from US-UI-003
  - Collapsible header: "X results found"
- Rejected results section:
  - Collapsed by default, hidden if no rejected results
  - Uses muted styling: `text-muted-foreground`, `bg-muted/30`
  - Shows title + italic rejection reason per result
  - FilterIcon + "X results filtered out" header
- Logic review findings (all addressed):
  - HIGH: Two-phase loading logic was broken (both branches went to "filtering")
    - FIXED: Simplified to single-phase since tool doesn't stream partial timing data
  - LOW: Rejected trigger missing focus-visible styling - FIXED
- TypeScript compiles with no errors in new component
- Pre-existing TS errors in codebase unrelated to this change
- Next story: US-UI-005 (Integrate Tool Components into Message Rendering)
- Note: Browser testing deferred to US-UI-005 when components are integrated into Chat.tsx

### 2026-02-01: US-UI-005 - Integrate Tool Components into Message Rendering
- Modified `src/features/chat/components/Chat.tsx` to render TikTok and WebSearch tool components
- Added imports for TikTokSearchTool, WebSearchTool, and generic Tool components
- Refactored tool part extraction:
  - Extract all tool parts first with type guard `isToolPart()`
  - Group by tool name using `getToolNameFromType()`
  - Added `KNOWN_TOOLS` set: `["readLink", "searchTikTok", "filteredWebSearch"]`
  - Unknown tools render with generic Tool/ToolHeader/ToolInput/ToolOutput
- Added `unknownToolParts` filter for fallback to generic tool display (PRD requirement)
- TypeScript compiles with no errors in Chat.tsx
- Pre-existing TS errors in codebase unrelated to this change
- Browser testing verified with agent-browser:
  - Sent "Search TikTok for best productivity tips" message
  - TikTokSearchTool rendered: "10 videos found" collapsible header
  - Video cards render with thumbnail, @handle, view/like/share stats
  - Expanding card shows full transcript + "Open on TikTok" link
  - AI synthesized response referencing creator insights
  - filteredWebSearch tool was detected but failed with "EXA_API_KEY not configured" (env config issue, not code)
- Logic review passed - fixed redundant `.map()` cast (it was actually needed for TypeScript type narrowing)
- Next story: US-INT-001 (End-to-End Integration Test - TikTok Search) or US-INT-002 (Filtered Web Search E2E)
- Note: The US-INT-* stories are end-to-end integration tests that verify the complete flow. The tool components are now working.

### 2026-02-01: US-INT-001 - End-to-End Integration Test - TikTok Search
- This is an E2E test story to verify the complete TikTok search flow in a real browser session
- Browser testing verified with agent-browser:
  - Started dev server (`pnpm dev`), ran `./scripts/browser-login.sh` to authenticate
  - Navigated to chat page, created new thread via "New Chat" button
  - Sent message: "Search TikTok for best productivity tips"
  - **VERIFIED**: TikTok cards rendered in horizontal scroll grid
  - **VERIFIED**: Cards show thumbnails, @handles (@ayshagonzalez, @tayrankine, etc.), engagement stats (views, likes, shares with icons)
  - **VERIFIED**: Clicking card header expands to show full transcript
  - **VERIFIED**: "Open on TikTok" link correctly opens TikTok video URL (e.g., `https://www.tiktok.com/@ayshagonzalez/video/7241358751872257326`)
  - **VERIFIED**: AI synthesizes response with "Top Productivity Tips from TikTok:" referencing creator insights
  - **VERIFIED**: Clicking "10 videos found" header collapses/expands the results section
- No code changes required - this was a verification test of existing implementation
- Pre-existing TS errors in codebase unrelated to this story
- Screenshots captured in `/testing/screenshots/` for documentation
- Next story: US-INT-002 (End-to-End Integration Test - Filtered Web Search)
